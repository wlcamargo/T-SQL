--USE ESCOLA_ANALISE_DADOS
--GO

--DROP TABLE IF EXISTS TB_REPETIDOS
--GO

--CREATE TABLE [dbo].[TB_REPETIDOS](
--	[COD] [int] NULL,
--	[DATA_PREV] [date] NULL,
--	[DATA_REAL] [date] NULL
--)
--GO

--INSERT INTO TB_REPETIDOS VALUES 
--(1,'2021-01-01','2021-02-01'),
--(1,'2021-02-01','2021-03-01'),
--(1,'2021-03-01','2021-04-01'),
--(1,'2021-04-01','2021-05-01'),
--(2,'2021-01-01','2022-01-01'),
--(2,'2021-02-01','2022-02-01'),
--(2,'2021-03-01','2022-03-01'),
--(2,'2021-04-01','2022-04-01'),
--(2,'2021-05-01','2022-05-01'),
--(3,'2021-01-01',NULL),
--(3,'2021-02-01',NULL),
--(3,'2021-03-01',NULL),
--(4,'2021-01-01','2021-06-01'),
--(4,'2021-07-01','2022-01-01'),
--(4,'2022-06-01','2023-07-01')
--GO

SELECT * FROM TB_REPETIDOS
GO

WITH AGG_COD AS (
SELECT 
	COD, 
	MAX(DATA_PREV) AS MAX_DATA_PREV
FROM 
	TB_REPETIDOS
GROUP BY 
	COD
)
SELECT 
	AC.COD,
	AC.MAX_DATA_PREV,
	TF.DATA_REAL
FROM
	AGG_COD AC
	INNER JOIN 
		(SELECT COD, DATA_PREV, DATA_REAL FROM TB_REPETIDOS) TF ON TF.COD = AC.COD 
															   AND TF.DATA_PREV = AC.MAX_DATA_PREV
ORDER BY
	1
GO

